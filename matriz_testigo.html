<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Reporte de Testigos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .matrix-table th, .matrix-table td {
            min-width: 120px;
            text-align: center;
        }
        .matrix-table th.name-header, .matrix-table td.name-cell {
            text-align: left;
            font-weight: 600;
        }
        .diagonal-cell {
            background-color: #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Vista del Administrador -->
    <div id="admin-view" class="container mx-auto p-4 md:p-8 hidden">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Panel de Administrador</h1>
            <p class="text-gray-600 mb-6">Configura la matriz y descarga los resultados.</p>

            <div class="mb-6">
                <label for="names-input" class="block text-sm font-medium text-gray-700 mb-2">Nombres de las Personas (uno por línea):</label>
                <textarea id="names-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos Rodríguez"></textarea>
            </div>

            <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Generar Matriz y Obtener Enlace
            </button>

            <div id="link-container" class="mt-6 hidden">
                <label for="shareable-link" class="block text-sm font-medium text-gray-700 mb-2">Enlace para Compartir con Encuestados:</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="shareable-link" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    <button id="copy-link-btn" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Copiar</button>
                </div>
                 <p id="copy-feedback" class="text-sm text-green-600 mt-1 h-4"></p>
            </div>

            <div class="mt-8 border-t pt-6">
                 <h2 class="text-xl font-semibold text-gray-800 mb-4">Reporte de Respuestas</h2>
                 <p class="text-gray-600 mb-4">Cuando haya respuestas, podrás descargarlas aquí.</p>
                <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Descargar Reporte (CSV)
                </button>
            </div>
        </div>
    </div>

    <!-- Vista del Encuestado -->
    <div id="respondent-view" class="container mx-auto p-4 md:p-8 hidden">
        <div id="form-container" class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 text-center">Reporte Confidencial</h1>
            <p class="text-md text-gray-700 mb-6 font-semibold text-center">¿Has sido testigo de que la persona en la <span class="text-red-600">fila</span> ha golpeado a la persona en la <span class="text-blue-600">columna</span>?</p>

            <div id="matrix-container" class="overflow-x-auto">
                <!-- La matriz se generará aquí -->
            </div>

            <button id="submit-btn" class="mt-8 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Enviar Respuestas
            </button>
        </div>
        <div id="thank-you-message" class="hidden text-center max-w-2xl mx-auto bg-white p-12 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-green-600">Respuesta Enviada</h2>
            <p class="mt-4 text-gray-700 text-lg">Gracias por tu participación. Tu respuesta ha sido registrada de forma anónima.</p>
        </div>
         <div id="no-config-message" class="hidden text-center max-w-2xl mx-auto bg-white p-12 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-red-600">Error de Configuración</h2>
            <p class="mt-4 text-gray-700 text-lg">Esta encuesta no ha sido configurada correctamente. Por favor, contacta al administrador.</p>
        </div>
    </div>

    <script>
        const adminView = document.getElementById('admin-view');
        const respondentView = document.getElementById('respondent-view');
        const namesInput = document.getElementById('names-input');
        const generateBtn = document.getElementById('generate-btn');
        const linkContainer = document.getElementById('link-container');
        const shareableLink = document.getElementById('shareable-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const downloadBtn = document.getElementById('download-btn');
        const matrixContainer = document.getElementById('matrix-container');
        const submitBtn = document.getElementById('submit-btn');
        const formContainer = document.getElementById('form-container');
        const thankYouMessage = document.getElementById('thank-you-message');
        const noConfigMessage = document.getElementById('no-config-message');

        const NAMES_KEY = 'matrix_names';
        const RESPONSES_KEY = 'matrix_responses';

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                setupAdminView();
            } else {
                setupRespondentView();
            }
        };

        // --- Lógica del Administrador ---
        function setupAdminView() {
            adminView.classList.remove('hidden');
            
            // Cargar nombres guardados si existen
            const savedNames = localStorage.getItem(NAMES_KEY);
            if(savedNames) {
                namesInput.value = JSON.parse(savedNames).join('\n');
            }

            generateBtn.addEventListener('click', () => {
                const names = namesInput.value.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                if (names.length < 2) {
                    alert('Por favor, introduce al menos dos nombres.');
                    return;
                }

                localStorage.setItem(NAMES_KEY, JSON.stringify(names));

                const respondentUrl = `${window.location.origin}${window.location.pathname}`;
                shareableLink.value = respondentUrl;
                linkContainer.classList.remove('hidden');
                copyFeedback.textContent = '';
                alert('¡Matriz configurada! Comparte el enlace de abajo con los encuestados.');
            });

            copyLinkBtn.addEventListener('click', () => {
                shareableLink.select();
                document.execCommand('copy');
                copyFeedback.textContent = '¡Enlace copiado!';
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            });

            downloadBtn.addEventListener('click', () => {
                const responses = JSON.parse(localStorage.getItem(RESPONSES_KEY) || '[]');
                if (responses.length === 0) {
                    alert('Aún no se han registrado respuestas.');
                    return;
                }

                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'Timestamp,Agresor (Fila),Victima (Columna)\r\n';

                responses.forEach(response => {
                    const timestamp = new Date(response.timestamp).toLocaleString('es-ES');
                    response.events.forEach(event => {
                        const row = `"${timestamp}","${event.aggressor}","${event.victim}"`;
                        csvContent += row + '\r\n';
                    });
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'reporte_testigos.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }


        // --- Lógica del Encuestado ---
        function setupRespondentView() {
            respondentView.classList.remove('hidden');
            const names = JSON.parse(localStorage.getItem(NAMES_KEY) || 'null');

            if (!names || names.length < 2) {
                formContainer.classList.add('hidden');
                noConfigMessage.classList.remove('hidden');
                return;
            }

            generateMatrix(names);

            submitBtn.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('#matrix-container input[type="checkbox"]:checked');
                const witnessedEvents = [];

                checkboxes.forEach(box => {
                    witnessedEvents.push({
                        aggressor: box.dataset.row,
                        victim: box.dataset.col
                    });
                });
                
                if (witnessedEvents.length > 0) {
                    const allResponses = JSON.parse(localStorage.getItem(RESPONSES_KEY) || '[]');
                    allResponses.push({
                        timestamp: new Date().toISOString(),
                        events: witnessedEvents
                    });
                    localStorage.setItem(RESPONSES_KEY, JSON.stringify(allResponses));
                }

                formContainer.classList.add('hidden');
                thankYouMessage.classList.remove('hidden');
            });
        }

        function generateMatrix(names) {
            const table = document.createElement('table');
            table.className = 'w-full border-collapse matrix-table';

            // Cabecera de la tabla (Columnas)
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            let th = document.createElement('th');
            th.className = 'p-3 border border-gray-300 bg-gray-100';
            headerRow.appendChild(th); // Celda vacía en la esquina

            names.forEach(name => {
                th = document.createElement('th');
                th.className = 'p-3 border border-gray-300 bg-blue-100 text-blue-800';
                th.textContent = name;
                headerRow.appendChild(th);
            });

            // Cuerpo de la tabla (Filas)
            const tbody = table.createTBody();
            names.forEach(rowName => {
                const row = tbody.insertRow();
                let cell = row.insertCell();
                cell.textContent = rowName;
                cell.className = 'name-cell p-3 border border-gray-300 bg-red-100 text-red-800';
                
                names.forEach(colName => {
                    cell = row.insertCell();
                    cell.className = 'p-3 border border-gray-300';

                    if (rowName === colName) {
                        cell.className += ' diagonal-cell';
                    } else {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.row = rowName;
                        checkbox.dataset.col = colName;
                        checkbox.className = 'h-6 w-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer';
                        cell.appendChild(checkbox);
                    }
                });
            });

            matrixContainer.appendChild(table);
        }

    </script>
</body>
</html>
