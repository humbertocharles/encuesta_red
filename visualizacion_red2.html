<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Red de Agresiones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .node {
            cursor: pointer;
        }
        .node text {
            font-size: 12px;
            paint-order: stroke;
            stroke: #fff;
            stroke-width: 3px;
            stroke-linecap: butt;
            stroke-linejoin: round;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .arrow-head {
            fill: #999;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col">
        <div class="max-w-4xl w-full mx-auto text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Red de Interacciones y Resumen</h1>
            <p class="text-gray-600">Visualización de los datos recopilados. Las flechas apuntan de la persona agresora a la víctima.</p>
        </div>

        <!-- Contenedor de la Tabla de Resumen -->
        <div id="summary-container" class="max-w-4xl w-full mx-auto bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Tabla de Resumen de Agresiones</h2>
            <div id="summary-table">
                <!-- La tabla se generará aquí -->
            </div>
        </div>

        <div id="visualization-container" class="relative w-full flex-grow bg-white rounded-xl shadow-lg border border-gray-200" style="min-height: 500px;">
            <!-- La visualización D3 se renderizará aquí -->
        </div>

        <div id="no-data-message" class="hidden text-center max-w-2xl mx-auto bg-white p-12 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-red-600">No se Encontraron Datos</h2>
            <p class="mt-4 text-gray-700 text-lg">Abre primero la herramienta de recolección de datos (`matriz_reporte.html`), configura la matriz y registra al menos una respuesta para poder visualizar la red.</p>
        </div>
    </div>

    <script>
        const RESPONSES_KEY = 'matrix_responses';
        const NAMES_KEY = 'matrix_names';

        window.onload = () => {
            const rawResponses = JSON.parse(localStorage.getItem(RESPONSES_KEY) || '[]');
            const allNames = JSON.parse(localStorage.getItem(NAMES_KEY) || '[]');

            const visContainer = document.getElementById('visualization-container');
            const summaryContainer = document.getElementById('summary-container');
            const noDataMessage = document.getElementById('no-data-message');

            if (rawResponses.length === 0 || allNames.length === 0) {
                visContainer.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }
            summaryContainer.classList.remove('hidden');

            // Procesar datos para D3
            const nodes = allNames.map(name => ({ id: name }));

            const linksMap = new Map();
            rawResponses.forEach(response => {
                response.events.forEach(event => {
                    const linkKey = `${event.aggressor}->${event.victim}`;
                    if (linksMap.has(linkKey)) {
                        linksMap.get(linkKey).weight += 1;
                    } else {
                        linksMap.set(linkKey, {
                            source: event.aggressor,
                            target: event.victim,
                            weight: 1
                        });
                    }
                });
            });
            const links = Array.from(linksMap.values());
            
            // Calcular estadísticas para la tabla
            const stats = new Map();
            allNames.forEach(name => {
                stats.set(name, { aggressions: 0, victimizations: 0 });
            });
            links.forEach(link => {
                const aggressorStats = stats.get(link.source);
                aggressorStats.aggressions += link.weight;

                const victimStats = stats.get(link.target);
                victimStats.victimizations += link.weight;
            });
            
            // Renderizar la tabla y el gráfico
            renderSummaryTable(stats);
            createNetworkGraph(nodes, links);
        };

        function renderSummaryTable(stats) {
            const container = document.getElementById('summary-table');
            const sortedStats = Array.from(stats.entries()).sort((a, b) => a[0].localeCompare(b[0]));

            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Agresiones Realizadas</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Agresiones Recibidas</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            sortedStats.forEach(([name, data]) => {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center font-semibold">${data.aggressions}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center font-semibold">${data.victimizations}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHTML;
        }

        function createNetworkGraph(nodes, links) {
            const container = document.getElementById('visualization-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container).append("svg")
                .attr("viewBox", [0, 0, width, height])
                .style("width", "100%")
                .style("height", "100%");

            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 23)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("class", "arrow-head");
            
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .attr("stroke-width", d => Math.sqrt(d.weight) * 2)
                .attr("marker-end", "url(#arrow)");

            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .call(drag(simulation));

            node.append("circle")
                .attr("r", 15)
                .attr("fill", "#6366f1");

            node.append("text")
                .text(d => d.id)
                .attr("x", 20)
                .attr("y", 5)
                .attr("fill", "#111827");

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }
        }
    </script>
</body>
</html>

